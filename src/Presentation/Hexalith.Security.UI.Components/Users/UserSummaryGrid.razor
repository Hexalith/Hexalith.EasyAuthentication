@inject IUserService UserService
@inject NavigationManager NavigationManager
@using Labels = Hexalith.Security.UI.Components.Resources.Users.UserSummaryGrid

<FluentDataGrid TGridItem="UserSummaryViewModel" Items="@_users?.AsQueryable()" ResizableColumns="true">
	<PropertyColumn Property="@(p => p.Id)" Title="@Labels.Id" />
	<PropertyColumn Property="@(p => p.Name)" Title="@Labels.Name" />
	<PropertyColumn Property="@(p => p.Email)" Title="@Labels.Email" />
	<TemplateColumn Title="Administrator" Align="@Align.Center">
		<FluentCheckbox Value="@(context.GlobalAdministrator)" aria-label="Administrator" Onclick="@(() => OnGlobalAdministrator(context))" />
	</TemplateColumn>
	<TemplateColumn Title="Disabled" Align="@Align.Center">
		<FluentCheckbox Value="@context.Disabled" aria-label="Enabled" Onclick="@(() => OnDisabled(context))" />
	</TemplateColumn>
	<TemplateColumn Title="Actions" Align="@Align.End">
		<FluentButton aria-label="Edit" IconEnd="@(new Icons.Regular.Size16.Edit())" Onclick="@(() => OnEdit(context))" />
		<FluentButton aria-label="Disable" Disabled="@(!context.GlobalAdministrator)" IconEnd="@(new Icons.Regular.Size16.RecordStop())" Onclick="@(() => OnDisable(context))" />
		<FluentButton aria-label="Delete" Disabled="@(!context.GlobalAdministrator)" IconEnd="@(new Icons.Regular.Size16.Delete())" Onclick="@(() => OnDelete(context))" />
	</TemplateColumn>
</FluentDataGrid>
@if (_users is null)
{
	<FluentProgressRing />
}


@code {
	private IEnumerable<UserSummaryViewModel>? _users;

	protected override async Task OnInitializedAsync()
	{
		_users = await UserService.GetAllAsync(CancellationToken.None);
		await base.OnInitializedAsync();
	}
	private async Task OnDelete(UserSummaryViewModel context)
	{
		await UserService.DeleteAsync(context.Id, CancellationToken.None);
		StateHasChanged();
	}
	private async Task OnDisable(UserSummaryViewModel context)
	{
		await UserService.DisableAsync(context.Id, CancellationToken.None);
		StateHasChanged();
	}
	private void OnEdit(UserSummaryViewModel context)
	{
		NavigationManager.NavigateTo($"/Security/User/{context.Id}/Edit");
	}
	private async Task OnGlobalAdministrator(UserSummaryViewModel context)
	{
		if (context.GlobalAdministrator)
			await UserService.RemoveGlobalAdministratorAsync(context.Id, CancellationToken.None);
		else
			await UserService.AddGlobalAdministratorAsync(context.Id, CancellationToken.None);
		StateHasChanged();
	}
	private async Task OnDisabled(UserSummaryViewModel context)
	{
		if (context.Disabled)
			await UserService.EnableAsync(context.Id, CancellationToken.None);
		else
			await UserService.DisableAsync(context.Id, CancellationToken.None);
		_users = _users!
			.Where(p => p.Id != context.Id)
			.Union([await UserService.GetSummaryAsync(context.Id, CancellationToken.None)])
			.OrderBy(p => p.Name);
		StateHasChanged();
	}

}
